---
import Container from "@components/container.astro";
import Contactform from "@components/contactform.astro";
import { Icon } from "astro-icon/components";
import { grantsServices, suggestedPacks } from "../content/grants/services-data.js";

const { content, lang = "en" } = Astro.props;
const locale = lang === "es" || lang === "cat" ? lang : "en";
const currency = locale === "en" ? "EUR" : "EUR";
---

<Container class="pb-16">
  <section class="mt-14 max-w-5xl mx-auto text-center">
    <p class="text-sm font-semibold uppercase tracking-[0.16em] text-indigo-700">{content.eyebrow}</p>
    <h1 class="mt-3 text-4xl md:text-5xl font-bold tracking-tight text-slate-900">{content.title}</h1>
    <p class="mt-4 text-lg text-slate-700 leading-relaxed">{content.intro}</p>
  </section>

  <section class="mt-12 max-w-5xl mx-auto text-center">
    <h2 class="text-2xl font-semibold text-slate-900">{content.companyBudgetTitle}</h2>
    <p class="mt-3 text-slate-700 leading-relaxed">{content.companyBudgetIntro}</p>
    <div class="mt-5 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
      {content.companyBudgets.map((tier) => (
        <article class="rounded-xl border border-slate-200 bg-white p-4 text-center">
          <Icon name={tier.icon} class="mx-auto h-6 w-6 text-indigo-600" />
          <h3 class="mt-2 text-sm font-semibold text-slate-900 leading-tight">{tier.name}</h3>
          <p class="mt-1 text-xs text-slate-600">{tier.workers}</p>
          <p class="mt-2 text-base font-bold text-indigo-700">{tier.amount}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="mt-12 max-w-6xl mx-auto text-center">
    <h2 class="text-2xl font-semibold text-slate-900">{content.servicesTitle}</h2>
    <p class="mt-3 text-slate-700 leading-relaxed">{content.servicesIntro}</p>
    <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3 text-center">
      {grantsServices.map((service) => (
        <article class="rounded-xl border border-slate-200 bg-white p-4">
          <div class="flex items-center justify-center gap-3">
            <div class="flex items-center justify-center gap-2">
              <Icon name={service.icon} class="h-5 w-5 text-indigo-600" />
              <h3 class="text-sm font-semibold text-slate-900">{service.name[locale]}</h3>
            </div>
            <details class="relative">
              <summary class="flex h-6 w-6 cursor-pointer items-center justify-center rounded-full border border-slate-300 text-xs font-bold text-slate-600 list-none">i</summary>
              <div class="absolute right-0 z-20 mt-2 w-64 rounded-lg border border-slate-200 bg-white p-3 text-xs text-slate-700 shadow-lg">
                <p>{service.description[locale]}</p>
                <p class="mt-2 font-semibold text-indigo-700">
                  {content.infoSubsidyLabel}: {Math.round(service.subsidyPercent * 100)}% · {content.infoMaxLabel}: {new Intl.NumberFormat(locale === 'en' ? 'en-US' : locale === 'es' ? 'es-ES' : 'ca-AD', { style: 'currency', currency }).format(service.maxSubsidy)}
                </p>
              </div>
            </details>
          </div>
        </article>
      ))}
    </div>
  </section>

  <section class="mt-12 max-w-6xl mx-auto">
    <h2 class="text-2xl font-semibold text-slate-900 text-center">{content.calculatorTitle}</h2>
    <p class="mt-3 text-slate-700 leading-relaxed text-center">{content.calculatorIntro}</p>

    <div class="mt-5 flex flex-wrap justify-center gap-2" id="pack-buttons">
      <button type="button" data-pack="micro" class="rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">{content.packMicro}</button>
      <button type="button" data-pack="ecommerce" class="rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">{content.packEcommerce}</button>
      <button type="button" data-pack="automation" class="rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">{content.packAutomation}</button>
      <button type="button" data-pack="clear" class="rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">{content.packClear}</button>
    </div>

    <div class="mt-6 overflow-x-auto rounded-xl border border-slate-200 bg-white">
      <table class="w-full min-w-[900px] text-sm">
        <thead class="bg-slate-50">
          <tr class="text-slate-700">
            <th class="px-3 py-3 text-center">{content.colSelect}</th>
            <th class="px-3 py-3 text-left">{content.colService}</th>
            <th class="px-3 py-3 text-right">{content.colCost}</th>
            <th class="px-3 py-3 text-right">{content.colPercent}</th>
            <th class="px-3 py-3 text-right">{content.colSubsidy}</th>
            <th class="px-3 py-3 text-right">{content.colFinal}</th>
          </tr>
        </thead>
        <tbody>
          {grantsServices.map((service) => (
            <tr class="border-t border-slate-100" data-service-row data-id={service.id} data-cost={service.baseCost} data-percent={service.subsidyPercent} data-max={service.maxSubsidy}>
              <td class="px-3 py-3 text-center">
                <input type="checkbox" class="service-toggle h-4 w-4" />
              </td>
              <td class="px-3 py-3">
                <div class="flex items-center justify-center gap-2">
                  <Icon name={service.icon} class="h-4 w-4 text-indigo-600" />
                  <span>{service.name[locale]}</span>
                </div>
              </td>
              <td class="px-3 py-3 text-right">{new Intl.NumberFormat(locale === 'en' ? 'en-US' : locale === 'es' ? 'es-ES' : 'ca-AD', { style: 'currency', currency }).format(service.baseCost)}</td>
              <td class="px-3 py-3 text-right">{Math.round(service.subsidyPercent * 100)}%</td>
              <td class="px-3 py-3 text-right subsidy-cell">{new Intl.NumberFormat(locale === 'en' ? 'en-US' : locale === 'es' ? 'es-ES' : 'ca-AD', { style: 'currency', currency }).format(0)}</td>
              <td class="px-3 py-3 text-right final-cell">{new Intl.NumberFormat(locale === 'en' ? 'en-US' : locale === 'es' ? 'es-ES' : 'ca-AD', { style: 'currency', currency }).format(0)}</td>
            </tr>
          ))}
        </tbody>
        <tfoot class="border-t-2 border-slate-200 bg-slate-50 font-semibold">
          <tr>
            <td class="px-3 py-3" colspan="2">{content.totalLabel}</td>
            <td class="px-3 py-3 text-right" id="total-cost">{new Intl.NumberFormat(locale === 'en' ? 'en-US' : locale === 'es' ? 'es-ES' : 'ca-AD', { style: 'currency', currency }).format(0)}</td>
            <td></td>
            <td class="px-3 py-3 text-right text-indigo-700" id="total-subsidy">{new Intl.NumberFormat(locale === 'en' ? 'en-US' : locale === 'es' ? 'es-ES' : 'ca-AD', { style: 'currency', currency }).format(0)}</td>
            <td class="px-3 py-3 text-right" id="total-final">{new Intl.NumberFormat(locale === 'en' ? 'en-US' : locale === 'es' ? 'es-ES' : 'ca-AD', { style: 'currency', currency }).format(0)}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <section class="mt-12 max-w-6xl mx-auto">
    <h2 class="text-2xl font-semibold text-slate-900 text-center">{content.timelineTitle}</h2>
    <div class="mt-6 overflow-x-auto pb-3">
      <ol class="flex min-w-[1200px] items-start gap-4">
        {content.timelineSteps.map((step, idx) => (
          <li class="relative w-64 shrink-0 rounded-xl border border-slate-200 bg-white p-4">
            <span class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-indigo-600 text-xs font-bold text-white">{idx + 1}</span>
            <h3 class="mt-3 text-sm font-semibold text-slate-900">{step.title}</h3>
            <p class="mt-2 text-xs leading-relaxed text-slate-600">{step.body}</p>
          </li>
        ))}
      </ol>
    </div>
    <ul class="mt-4 space-y-2 text-sm text-slate-700 text-center">
      {content.timelineNotes.map((note) => (
        <li>• {note}</li>
      ))}
    </ul>
  </section>

  <section class="mt-14 max-w-4xl mx-auto text-center">
    <h2 class="text-2xl font-semibold text-slate-900">{content.contactTitle}</h2>
    <p class="mt-3 text-slate-700 leading-relaxed">{content.contactIntro}</p>
    <div class="mt-6 text-left">
      <Contactform lang={lang} />
    </div>
  </section>

  <section class="mt-10 max-w-4xl mx-auto text-center">
    <p class="text-xs text-slate-500 leading-relaxed">{content.officialSource.description}
      <a href={content.officialSource.url} target="_blank" rel="noopener noreferrer" class="underline underline-offset-2 ml-1">{content.officialSource.footerCta}</a>
    </p>
  </section>
</Container>

<script is:inline define:vars={{ packs: suggestedPacks, locale }}>
  const formatter = new Intl.NumberFormat(locale === "en" ? "en-US" : locale === "es" ? "es-ES" : "ca-AD", {
    style: "currency",
    currency: "EUR",
  });

  const rows = Array.from(document.querySelectorAll("[data-service-row]"));
  const toggles = Array.from(document.querySelectorAll(".service-toggle"));

  function updateTotals() {
    let totalCost = 0;
    let totalSubsidy = 0;

    rows.forEach((row) => {
      const checkbox = row.querySelector(".service-toggle");
      const cost = Number(row.dataset.cost);
      const percent = Number(row.dataset.percent);
      const max = Number(row.dataset.max);
      const subsidyCell = row.querySelector(".subsidy-cell");
      const finalCell = row.querySelector(".final-cell");

      if (checkbox.checked) {
        const subsidy = Math.min(cost * percent, max);
        const finalCost = Math.max(cost - subsidy, 0);
        subsidyCell.textContent = formatter.format(subsidy);
        finalCell.textContent = formatter.format(finalCost);
        totalCost += cost;
        totalSubsidy += subsidy;
      } else {
        subsidyCell.textContent = formatter.format(0);
        finalCell.textContent = formatter.format(0);
      }
    });

    document.getElementById("total-cost").textContent = formatter.format(totalCost);
    document.getElementById("total-subsidy").textContent = formatter.format(totalSubsidy);
    document.getElementById("total-final").textContent = formatter.format(Math.max(totalCost - totalSubsidy, 0));
  }

  toggles.forEach((toggle) => toggle.addEventListener("change", updateTotals));

  document.getElementById("pack-buttons")?.addEventListener("click", (event) => {
    const button = event.target.closest("button[data-pack]");
    if (!button) return;
    const pack = button.dataset.pack;

    if (pack === "clear") {
      toggles.forEach((toggle) => (toggle.checked = false));
      updateTotals();
      return;
    }

    const ids = packs[pack] || [];
    rows.forEach((row) => {
      const checkbox = row.querySelector(".service-toggle");
      checkbox.checked = ids.includes(row.dataset.id);
    });
    updateTotals();
  });

  updateTotals();
</script>
