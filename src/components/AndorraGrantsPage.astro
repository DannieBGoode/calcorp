---
import Container from "@components/container.astro";
import Contactform from "@components/contactform.astro";
import { Icon } from "astro-icon/components";
import { grantsServices, suggestedPacks } from "../content/grants/services-data.js";

const { content, lang = "en" } = Astro.props;
const locale = lang === "es" || lang === "cat" ? lang : "en";
const localeCode = "en-US";
const formatEur = (value) => `${new Intl.NumberFormat(localeCode, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value)} EUR`;
---

<Container class="pb-16">
  <section class="mt-14 max-w-5xl mx-auto text-center">
    <p class="text-sm font-semibold uppercase tracking-[0.16em] text-indigo-700">{content.eyebrow}</p>
    <h1 class="mt-3 text-4xl md:text-5xl font-bold tracking-tight text-slate-900">{content.title}</h1>
    <p class="mt-4 text-lg text-slate-700 leading-relaxed">{content.intro}</p>
  </section>

  <section class="mt-12 max-w-5xl mx-auto text-center">
    <h2 class="text-2xl font-semibold text-slate-900">{content.companyBudgetTitle}</h2>
    <p class="mt-3 text-slate-700 leading-relaxed">{content.companyBudgetIntro}</p>
    <div class="mt-5 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
      {content.companyBudgets.map((tier) => (
        <article class="rounded-xl border border-slate-200 bg-white p-4 text-center">
          <Icon name={tier.icon} class="mx-auto h-6 w-6 text-indigo-600" />
          <h3 class="mt-2 text-sm font-semibold text-slate-900 leading-tight">{tier.name}</h3>
          <p class="mt-1 text-xs text-slate-600">{tier.workers}</p>
          <p class="mt-2 text-base font-bold text-indigo-700">{tier.amount}</p>
        </article>
      ))}
    </div>
  </section>

  <section class="relative z-30 mt-12 max-w-6xl mx-auto">
    <h2 class="text-2xl font-semibold text-slate-900 text-center">{content.calculatorTitle}</h2>
    <p class="mt-3 text-slate-700 leading-relaxed text-center">{content.calculatorIntro}</p>

    <div class="mt-5 flex flex-wrap justify-center gap-2" id="pack-buttons">
      <button type="button" data-pack="micro" class="rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700">{content.packMicro}</button>
      <button type="button" data-pack="ecommerce" class="rounded-full bg-fuchsia-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-fuchsia-700">{content.packEcommerce}</button>
      <button type="button" data-pack="automation" class="rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-700">{content.packAutomation}</button>
      <button type="button" data-pack="clear" class="px-3 py-2 text-sm font-semibold text-slate-600 underline underline-offset-4 hover:text-slate-900">{content.packClear}</button>
    </div>

    <div class="mt-6 overflow-x-auto rounded-xl border border-slate-200 bg-white">
      <table class="w-full min-w-[660px] text-sm">
        <thead class="bg-slate-50">
          <tr class="text-slate-700">
            <th class="px-3 py-3 text-center">{content.colSelect}</th>
            <th class="px-3 py-3 text-left">{content.colService}</th>
            <th class="px-3 py-3 text-right">{content.colCost}</th>
            <th class="px-3 py-3 text-right">{content.colSubsidy}</th>
            <th class="px-3 py-3 text-right">{content.colFinal}</th>
          </tr>
        </thead>
        <tbody>
          {grantsServices.map((service) => (
            <tr class="border-t border-slate-100" data-service-row data-id={service.id} data-cost={service.baseCost} data-percent={service.subsidyPercent} data-max={service.maxSubsidy}>
              <td class="px-3 py-3 text-center">
                <input type="checkbox" class="service-toggle h-4 w-4" />
              </td>
              <td class="px-3 py-3">
                <div class="flex items-center gap-2">
                  <Icon name={service.icon} class="h-4 w-4 text-indigo-600" />
                  <span>{service.name[locale]}</span>
                  <details class="relative ml-1 z-[90] info-popup">
                    <summary class="flex h-5 w-5 cursor-pointer items-center justify-center rounded-full border border-slate-300 text-[10px] font-bold text-slate-600 list-none">i</summary>
                    <div class="absolute left-0 z-[100] mt-2 w-64 rounded-lg border border-slate-200 bg-white p-3 text-xs text-slate-700 shadow-xl">
                      <p>{service.description[locale]}</p>
                      <p class="mt-2 font-semibold text-indigo-700">
                        {content.infoSubsidyLabel}: {Math.round(service.subsidyPercent * 100)}% · {content.infoMaxLabel}: {formatEur(service.maxSubsidy)}
                      </p>
                    </div>
                  </details>
                </div>
              </td>
              <td class="px-3 py-3 text-right">{formatEur(service.baseCost)}</td>
              <td class="px-3 py-3 text-right subsidy-cell text-slate-900" data-is-75={service.subsidyPercent === 0.75 ? "true" : "false"}>{formatEur(0)}</td>
              <td class="px-3 py-3 text-right final-cell">{formatEur(0)}</td>
            </tr>
          ))}
        </tbody>
        <tfoot class="border-t-2 border-slate-200 bg-slate-50 font-semibold">
          <tr>
            <td class="px-3 py-3" colspan="2">{content.totalLabel}</td>
            <td class="px-3 py-3 text-right" id="total-cost">{formatEur(0)}</td>
            <td class="px-3 py-3 text-right text-indigo-700" id="total-subsidy">{formatEur(0)}</td>
            <td class="px-3 py-3 text-right" id="total-final">{formatEur(0)}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <section class="relative z-0 mt-12 max-w-6xl mx-auto">
    <h2 class="text-2xl font-semibold text-slate-900 text-center">{content.timelineTitle}</h2>
    <div class="mt-6 overflow-x-auto pb-3">
      <ol class="relative flex min-w-[1280px] items-start gap-4 pt-6">
        <div class="absolute left-6 right-6 top-10 h-0.5 bg-indigo-200" aria-hidden="true"></div>
        {content.timelineSteps.map((step, idx) => (
          <li class="relative w-64 shrink-0 rounded-xl border border-slate-200 bg-white p-4">
            <span class="absolute -top-4 left-1/2 -translate-x-1/2 inline-flex h-7 w-7 items-center justify-center rounded-full border-2 border-indigo-600 bg-white text-xs font-bold text-indigo-700">
              {idx + 1}
            </span>
            <h3 class="mt-4 text-sm font-semibold text-slate-900">{step.title}</h3>
            <p class="mt-2 text-xs leading-relaxed text-slate-600">{step.body}</p>
          </li>
        ))}
      </ol>
    </div>
    <ul class="mt-4 space-y-2 text-sm text-slate-700 text-center">
      {content.timelineNotes.map((note) => (
        <li>• {note}</li>
      ))}
    </ul>
  </section>

  <section class="mt-14 max-w-4xl mx-auto text-center">
    <h2 class="text-2xl font-semibold text-slate-900">{content.contactTitle}</h2>
    <p class="mt-3 text-slate-700 leading-relaxed">{content.contactIntro}</p>
    <div class="mt-6 text-left">
      <Contactform lang={lang} />
    </div>
  </section>

  <section class="mt-10 max-w-4xl mx-auto text-center">
    <p class="text-xs text-slate-500 leading-relaxed">{content.officialSource.description}
      <a href={content.officialSource.url} target="_blank" rel="noopener noreferrer" class="underline underline-offset-2 ml-1">{content.officialSource.footerCta}</a>
    </p>
  </section>
</Container>

<script is:inline define:vars={{ packs: suggestedPacks, locale }}>
  const formatter = new Intl.NumberFormat("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const formatEur = (value) => `${formatter.format(value)} EUR`;

  const rows = Array.from(document.querySelectorAll("[data-service-row]"));
  const toggles = Array.from(document.querySelectorAll(".service-toggle"));

  function updateTotals() {
    let totalCost = 0;
    let totalSubsidy = 0;

    rows.forEach((row) => {
      const checkbox = row.querySelector(".service-toggle");
      const cost = Number(row.dataset.cost);
      const percent = Number(row.dataset.percent);
      const max = Number(row.dataset.max);
      const subsidyCell = row.querySelector(".subsidy-cell");
      const finalCell = row.querySelector(".final-cell");

      if (checkbox.checked) {
        const subsidy = Math.min(cost * percent, max);
        const finalCost = Math.max(cost - subsidy, 0);
        subsidyCell.textContent = formatEur(subsidy);
        finalCell.textContent = formatEur(finalCost);
        if (row.dataset.is75 === "true") {
          subsidyCell.classList.add("text-emerald-700", "font-bold");
          subsidyCell.classList.remove("text-slate-900");
        }
        totalCost += cost;
        totalSubsidy += subsidy;
      } else {
        subsidyCell.textContent = formatEur(0);
        finalCell.textContent = formatEur(0);
        subsidyCell.classList.remove("text-emerald-700", "font-bold");
        subsidyCell.classList.add("text-slate-900");
      }
    });

    document.getElementById("total-cost").textContent = formatEur(totalCost);
    document.getElementById("total-subsidy").textContent = formatEur(totalSubsidy);
    document.getElementById("total-final").textContent = formatEur(Math.max(totalCost - totalSubsidy, 0));
  }

  toggles.forEach((toggle) => toggle.addEventListener("change", updateTotals));

  document.getElementById("pack-buttons")?.addEventListener("click", (event) => {
    const button = event.target.closest("button[data-pack]");
    if (!button) return;
    const pack = button.dataset.pack;

    if (pack === "clear") {
      toggles.forEach((toggle) => (toggle.checked = false));
      updateTotals();
      return;
    }

    const ids = packs[pack] || [];
    rows.forEach((row) => {
      const checkbox = row.querySelector(".service-toggle");
      checkbox.checked = ids.includes(row.dataset.id);
    });
    updateTotals();
  });


  const infoPopups = Array.from(document.querySelectorAll("details.info-popup"));
  infoPopups.forEach((popup) => {
    popup.addEventListener("toggle", () => {
      if (!popup.open) return;
      infoPopups.forEach((other) => {
        if (other !== popup) other.open = false;
      });
    });
  });

  updateTotals();
</script>